<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <title>ElasticsearchTool</title>

    <!-- Bootstrap -->
    <link href="http://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <style>
        body {
            user-select: none;
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }

        .row {
            margin-right: 0;
            margin-left: 0;
        }

        .toolFrame {
            border: 1px #efefef solid;
            padding: 5px;
        }

        .execResult {
            margin-top: 15px;
            border: 1px #efefef solid;
            padding: 5px;
            word-break: break-all;
            word-wrap: break-word;
            overflow-y: auto;
            user-select: text;
            -moz-user-select: text;
            -webkit-user-select: text;
            -ms-user-select: text;
        }

        .import-btn {
            margin-top: 20px;
        }

        #exportSelectGroupN {
            border: 1px #efefef solid;
            max-height: 400px;
            padding-left: 10px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container-fluid">

        <h1>Elasticsearch实用工具集</h1>
        <!--<form id="es-form" role="form">-->

        <!--<div class="form-group">-->
        <!--<label for="es-port">请输入地址</label>-->
        <!--<input id="es-port" placeholder="如：127.0.0.1:9200" />-->
        <!--<button id="esConnect" class="btn btn-primary" >连接</button>-->
        <!--</div>-->

        <!--</form>-->


        <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active">
                <a href="#typeExport" role="tab" data-toggle="tab">数据查询与导出</a>
            </li>
            <li role="presentation">
                <a href="#typeImport" role="tab" data-toggle="tab">数据导入</a>
            </li>
            <li role="presentation">
                <a href="#typeUpgrade" role="tab" data-toggle="tab">数据迁移</a>
            </li>
            <li role="presentation">
                <a href="#bulkDelete" role="tab" data-toggle="tab">批量删除</a>
            </li>
            <li role="presentation">
                <a href="#flywayDelete" role="tab" data-toggle="tab">flyway删除</a>
            </li>
            <li role="presentation">
                <a href="#routingDelete" role="tab" data-toggle="tab">删除路由</a>
            </li>
            <li role="presentation">
                <a id="dataExportToggle" href="#dataExport" role="tab" data-toggle="tab">批量导出</a>
            </li>
        </ul>

        <div class="tab-content">
            <!--导出数据-->
            <div role="tabpanel" class="tab-pane active" id="typeExport">
                <div class="toolWrapper row">
                    <div id="exportTool" class="toolFrame col-xs-12 col-md-6">
                        <h2>数据查询及导出功能</h2>
                        <form id="exportForm" role="form">
                            <div class="form-group">
                                <label for="exportIndex">index</label>
                                <div class="form-group">
                                    <select class="form-control _index" id="exportIndex">
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="exportType">type</label>
                                <div class="form-group">
                                    <select class="form-control _type" id="exportType">
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="exportRouting">routing</label>
                                <input type="text" class="form-control" id="exportRouting" placeholder="routing">
                            </div>
                            <button type="submit" class="btn btn-default">查询</button>
                            <button type="button" class="btn btn-default exportJson">下载</button>
                        </form>
                        <textarea id="exportResult" cols="70" class="execResult"></textarea>
                    </div>
                    <div class="toolFrame col-xs-12 col-md-6">
                        <h3>usage:</h3>
                        <p>选择index和type,点击“查询”可显示该type下所有数据，点击“下载”可下载该数据json文件</p>
                    </div>
                </div>
            </div>
            <!--导入数据-->
            <div role="tabpanel" class="tab-pane" id="typeImport">
                <div class="toolWrapper row">

                    <div id="importTool" class="toolFrame col-xs-12 col-md-6">
                        <!--<div>
                            <button class="btn btn-default import-btn" disabled="disabled">导入数据</button>
                        </div>-->
                        <h2>数据导入功能</h2>
                        <form id="importForm" role="form">
                            <div class="form-group">
                                <label for="importData">请在此填入数据</label>
                                <textarea id="importData" class="form-control" rows="4" placeholder="data"></textarea>
                            </div>
                            <button type="submit" class="btn btn-default">开始导入</button>
                        </form>
                        <textarea id="importResult" cols="70" class="execResult"></textarea>
                    </div>
                    <div class="toolFrame col-xs-12 col-md-6">
                        <h3>usage:</h3>
                        <p>拷贝本工具集“数据查询及导出功能”查询得到的json结果,填入数据，执行“开始导入”即可。</p>
                    </div>
                </div>
            </div>
            <!-- 数据迁移 -->
            <div role="tabpanel" class="tab-pane" id="typeUpgrade">
                <div class="toolWrapper row">
                    <div id="upgradeTool" class="toolFrame col-xs-12 col-md-6">
                        <h2>数据迁移</h2>
                        <form id="upgradeForm" role="form">
                            <!--<div class="form-group">
                                <label for="upgradeFromIndex">from index</label>
                                <input type="text" class="form-control" id="upgradeFromIndex" placeholder="from index">
                            </div>-->
                            <div class="form-group">
                                <label for="upgradeFromIndex">起始索引</label>
                                <div class="form-group">
                                    <select class="form-control _index" id="upgradeFromIndex">
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="upgradeToIndex">目标索引</label>
                                <div class="form-group">
                                    <select class="form-control _index" id="upgradeToIndex">
                                    </select>
                                </div>
                            </div>
                            <!--<div class="form-group">
                                <label for="upgradeToIndex">目标索引</label>
                                <input type="text" class="form-control" id="upgradeToIndex" placeholder="to index">
                            </div>-->
                            <button type="submit" class="btn btn-default">开始迁移</button>
                        </form>
                        <p id="upgradeResult" class="execResult"></p>
                    </div>
                    <div class="toolFrame col-xs-12 col-md-6">
                        <h3>usage:</h3>
                        <p>迁移索引数据。</p>
                        <p>将起始索引的数据迁移到目标索引中。</p>
                    </div>
                </div>
            </div>

            <!--批量删除-->
            <div role="tabpanel" class="tab-pane" id="bulkDelete">
                <div class="toolWrapper row">
                    <div id="bulkDeleteTool" class="toolFrame col-xs-12 col-md-6">
                        <h2>以type为单位删除数据</h2>
                        <form id="bulkDeleteForm" role="form">
                            <div class="form-group">
                                <label for="bulkDeleteIndex">index</label>
                                <div class="form-group">
                                    <select class="form-control _index" id="bulkDeleteIndex">
                                    </select>
                                </div>
                                <!--<input type="text" class="form-control" id="bulkDeleteIndex" placeholder="index">-->
                            </div>
                            <div class="form-group">
                                <label for="bulkDeleteType">type</label>
                                <!--<input type="text" class="form-control _type" id="bulkDeleteType" placeholder="type">-->
                                <div class="form-group">
                                    <select class="form-control _type" id="bulkDeleteType">
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="bulkDeleteRouting">routing</label>
                                <input type="text" class="form-control" id="bulkDeleteRouting" placeholder="routing，按id删除时有routing的数据须填；按data删除可不填">
                            </div>
                            <div class="form-group">
                                <label for="bulkDeleteData">data</label>
                                <textarea id="bulkDeleteData" class="form-control" rows="4" placeholder="请填写要删除数据的id集合，以逗号分隔；或者传入查询出的数据，兼容head插件查询出的数据"></textarea>
                            </div>
                            <button type="submit" class="btn btn-default">Submit</button>
                        </form>
                        <textarea id="bulkDeleteResult" cols="70" class="execResult"></textarea>
                    </div>
                    <div class="toolFrame col-xs-12 col-md-6">
                        <h3>usage:</h3>
                        <p>批量删除
                        </p>
                    </div>
                </div>
            </div>

            <!--flyway删除-->
            <div role="tabpanel" class="tab-pane" id="flywayDelete">
                <div class="toolWrapper row">
                    <div class="toolFrame col-xs-12 col-md-6">
                        <h2>flyway 删除</h2>
                        <form role="form">
                            <div class="form-group">
                                <label for="bulkDeleteIndex">版本号</label>
                                <div class="form-group">
                                    <div class="form-group">
                                        <input class="form-control" id="deleteFlyVersion" />
                                    </div>
                                </div>
                            </div>

                            <button type="button" id="deleteFlyBtn" class="btn btn-default">删除</button>
                        </form>
                        <textarea id="flywayResult" cols="70" class="execResult"></textarea>

                    </div>
                    <div class="toolFrame col-xs-12 col-md-6">
                        <h3>usage:</h3>
                        <p> 根据版本号删除flyway一条信息</p>
                    </div>
                </div>
            </div>

            <!--路由删除-->
            <div role="tabpanel" class="tab-pane" id="routingDelete">
                <div class="toolWrapper row">
                    <div class="toolFrame col-xs-12 col-md-6">
                        <h2>路由删除功能</h2>
                        <form role="form">
                            <div class="form-group">
                                <label for="routingDeleteValue">路由值</label>
                                <div class="form-group">
                                    <div class="form-group">
                                        <input class="form-control" id="routingDeleteValue" />
                                    </div>
                                </div>
                            </div>

                            <button type="button" id="deleteRoutingBtn" class="btn btn-default">删除</button>
                        </form>
                        <textarea id="routingDelResult" cols="70" class="execResult"></textarea>

                    </div>
                    <div class="toolFrame col-xs-12 col-md-6">
                        <h3>usage:</h3>
                        <p> 根据路由值删除该路由下所有数据（请谨慎操作！）</p>
                    </div>
                </div>

            </div>

            <!--批量导出-->
            <div role="tabpanel" class="tab-pane" id="dataExport">
                <div class="toolWrapper row">
                    <div id="exportTool" class="toolFrame col-xs-12 col-md-6">
                        <h2>批量导出</h2>
                        <form id="exportFormN" role="form">
                            <div id="exportSelectGroupN" class="form-group"></div>
                            <div class="form-group">
                                <label for="exportRoutingN">routing</label>
                                <input type="text" class="form-control" id="exportRoutingN" placeholder="routing">
                            </div>
                            <button type="submit" class="btn btn-default">导出</button>
                        </form>
                        <textarea id="exportNResult" cols="70" class="execResult"></textarea>
                    </div>
                    <div class="toolFrame col-xs-12 col-md-6">
                        <h3>usage:</h3>
                        <p>选择index和type,点击“查询”可显示该type下所有数据，点击“下载”可下载该数据json文件</p>
                    </div>
                </div>
            </div>

        </div>

        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
        <!-- Include all compiled plugins (below), or include individual files as needed -->
        <script src="http://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <!--<script src="js/main.js"></script>-->
        <script>
            console.log("usage:");
            console.log("1.copy this file to /usr/local/elasticsearch-2.2.0/plugins/head/_site/");
            console.log("2.visit [host]:9200/_plugin/head/ElasticsearchTool.html");

            // global vars
            var indices = 0;

            // var host = getHost();
            var host = getHost();

            $(function () {

                //页面设置高度
                setHeight();

                // setAllIndex();
                getState();

                //
                // $("#esConnect").on('click',function () {
                //     var ip = $("#es-port").val();
                //      if(!ip.trim()){
                //          alert('所填地址为空，请重新填写！');
                //          return false;
                //      }
                //     setAllIndex(host);
                // });

                /**
                 * 导出
                 */
                $("#exportForm").on("submit", function (evt) {
                    evt.preventDefault();
                    msgExportResult("...");
                    var _index = $("#exportIndex").val().trim();
                    var exportType = $("#exportType").val().trim();
                    if (!_index) {
                        msgExportResult("参数为空");
                        return false;
                    }
                    var routing = $("#exportRouting").val().trim();
                    var routingQurey = '';
                    if (routing) {
                        routingQurey = '{"term":{ "_routing":"' + routing + '"}}';
                    }
                    var exportUrl = host + "/" + _index;
                    if (exportType) exportUrl += "/" + exportType;
                    exportUrl += "/_search";
                    $.ajax({
                        type: "POST",
                        url: exportUrl,
                        data: '{"from":0,"size":10000,"query":{"bool":{"must":[' + routingQurey + '],"must_not":[],' +
                            '"should":[{"match_all":{}}]}},"sort":[],"aggs":{},"version":true}',
                        success: function (result) {
                            var json = format(JSON.stringify(result), false);
                            msgExportResult(json);
                        },
                        error: function (result) {
                            msgExportResult(JSON.stringify(result));
                        }
                    });
                    return false;
                });


                /**
                 * 索引改变事件
                 */
                $("._index").on("change", function () {
                    var index = $(this).val();
                    console.log(index);
                    setTypes(index);

                });


                //导出文件
                $(".exportJson").on("click", function () {
                    var content = $("#exportResult").text();
                    if (!content.trim()) {
                        alert('内容为空，请点击Submit!');
                        return;
                    }
                    var fileName = $("#exportIndex").val() + "-" + $("#exportType").val() + ".json";
                    downloadFile(fileName, content);
                });


                /**
                 * 从文件中导入数据
                 */
                $(".import-btn").on("click", function () {
                    alert('待后续完成...');
                });


                /**
                 * 导入
                 */
                $("#importForm").on("submit", function (evt) {
                    evt.preventDefault();
                    msgImportResult("...");
                    var importData = $("#importData").val().trim();
                    if (!importData) {
                        msgImportResult("参数为空");
                        return false;
                    }

                    var importDataObj = JSON.parse(importData);
                    var dataBody;
                    if (typeof importDataObj.hits === "object" && !(importDataObj.hits instanceof Array) &&
                        typeof importDataObj.hits.hits === "object" && importDataObj.hits.hits instanceof Array) {
                        dataBody = importDataObj.hits.hits;
                    } else if (typeof importDataObj.hits === "object" && importDataObj.hits instanceof Array) {
                        dataBody = importDataObj.hits;
                    }
                    var bulkBody = "";
                    var i, dataItem, dataItemId, dataItemIndex, dataItemType, dataItemRouting, dataItemSource;
                    for (i = 0; i < dataBody.length; i++) {
                        dataItem = dataBody[i];
                        dataItemId = dataItem._id;
                        dataItemIndex = dataItem._index;
                        dataItemType = dataItem._type;
                        dataItemRouting = dataItem._routing;
                        dataItemSource = dataItem._source;

                        if (dataItemRouting) {
                            bulkBody += '{"index":{"_index":"' + dataItemIndex + '","_type":"' + dataItemType + '","_id":"' +
                                dataItemId + '","_routing":"' + dataItemRouting + '"}}\n';
                        } else {
                            bulkBody += '{"index":{"_index":"' + dataItemIndex + '","_type":"' + dataItemType + '","_id":"' +
                                dataItemId + '"}}\n';
                        }
                        bulkBody += JSON.stringify(dataItemSource) + '\n';
                    }

                    var importUrl = host + "/_bulk";
                    $.ajax({
                        type: "POST",
                        url: importUrl,
                        data: bulkBody,
                        success: function (result) {
                            msgImportResult(format(JSON.stringify(result)), false);
                        },
                        error: function (result) {
                            msgImportResult(JSON.stringify(result));
                        }
                    });
                    return false;
                });


                /**
                 * 删除
                 */
                $("#bulkDeleteForm").on("submit", function (evt) {
                    evt.preventDefault();
                    msgBulkDeleteResult("...");

                    var bulkDeleteIndex = $("#bulkDeleteIndex").val().trim();
                    var bulkDeleteType = $("#bulkDeleteType").val().trim();
                    var bulkDeleteRouting = $("#bulkDeleteRouting").val().trim();
                    var bulkDeleteData = $("#bulkDeleteData").val();
                    if (!bulkDeleteIndex || !bulkDeleteType) {
                        msgBulkDeleteResult("参数为空");
                        return false;
                    }

                    var bulkDeleteUrl = host + "/" + bulkDeleteIndex + "/" + bulkDeleteType + "/_bulk";

                    if (!bulkDeleteData) {
                        msgBulkDeleteResult("data为空");
                        return false;
                    }

                    // 尝试解析为json数据，失败再按id来处理
                    try {
                        var deleteDataObj = JSON.parse(bulkDeleteData);
                        bulkDelete(bulkDeleteUrl, deleteDataObj, function (err) {
                            var len = 0;
                            if (typeof deleteDataObj.hits === "object" && !(deleteDataObj.hits instanceof Array) &&
                                typeof deleteDataObj.hits.hits === "object" && deleteDataObj.hits.hits instanceof Array) {
                                len = deleteDataObj.hits.hits.length;
                            } else if (typeof deleteDataObj.hits === "object" && deleteDataObj.hits instanceof Array) {
                                len = deleteDataObj.hits.length;
                            }
                            msgBulkDeleteResult("删除完成！共删除" + len + "条数据。");
                        }, bulkDeleteRouting);
                    } catch (err) {
                        var delIds = bulkDeleteData.split(',');
                        bulkDeleteByIds(bulkDeleteUrl, bulkDeleteIndex, bulkDeleteType, bulkDeleteRouting, delIds, function (err, delLength) {
                            if (err) {
                                msgBulkDeleteResult("删除失败！" + err);
                            } else {
                                msgBulkDeleteResult("删除成功，共删除" + delLength + '条数据');
                            }
                        });
                    }
                });

                // type upgrade
                $("#upgradeResult").height($(".toolFrame").height() - 356 + 75);

                function msgUpgradeResult(msg) {
                    $("#upgradeResult").text(msg);
                }
                $("#upgradeForm").on("submit", function (evt) {
                    evt.preventDefault();
                    msgUpgradeResult("准备升级...");
                    var upgradeFromIndex = $("#upgradeFromIndex").val().trim();
                    var upgradeToIndex = $("#upgradeToIndex").val().trim();
                    if (!upgradeFromIndex || !upgradeToIndex) {
                        msgUpgradeResult("参数为空");
                        return false;
                    }

                    var upgradeQuery = function (results) {
                        try {
                            var importDataObj = results;
                            var dataBody;
                            if (typeof importDataObj.hits === "object" && !(importDataObj.hits instanceof Array) &&
                                typeof importDataObj.hits.hits === "object" && importDataObj.hits.hits instanceof Array) {
                                dataBody = importDataObj.hits.hits;
                            } else if (typeof importDataObj.hits === "object" && importDataObj.hits instanceof Array) {
                                dataBody = importDataObj.hits;
                            }
                            var bulkBody = "";
                            var i, dataItem, dataItemId, dataItemIndex, dataItemType, dataItemRouting, dataItemSource;
                            for (i = 0; i < dataBody.length; i++) {
                                dataItem = dataBody[i];
                                dataItemId = dataItem._id;
                                dataItemIndex = upgradeToIndex;
                                dataItemType = dataItem._type;
                                dataItemRouting = dataItem._routing;
                                dataItemSource = dataItem._source;

                                if (dataItemRouting) {
                                    bulkBody += '{"index":{"_index":"' + dataItemIndex + '","_type":"' + dataItemType + '","_id":"' +
                                        dataItemId + '","_routing":"' + dataItemRouting + '"}}\n';
                                } else {
                                    bulkBody += '{"index":{"_index":"' + dataItemIndex + '","_type":"' + dataItemType + '","_id":"' +
                                        dataItemId + '"}}\n';
                                }
                                bulkBody += JSON.stringify(dataItemSource) + '\n';
                            }

                            var importUrl = host + "/_bulk";
                            $.ajax({
                                type: "POST",
                                url: importUrl,
                                data: bulkBody,
                                success: function (result) {
                                    totalSucc += dataBody.length;
                                    msgUpgradeResult("需要升级总数：" + totalHits + "    已升级：" + totalSucc);
                                    if (errMsg.length > 0) msgUpgradeResult("升级中发生错误：" + errMsg + "    需要升级总数：" + totalHits + "    已升级：" + totalSucc);
                                },
                                error: function (result) {
                                    errMsg += 'ts    ';
                                    msgExportNResult(errMsg);
                                    console.error('error', ts, e);
                                }
                            });
                        } catch (err) {
                            errMsg += err.message + '    ';
                            msgUpgradeResult(errMsg);
                            console.error(err.message, err.stack);
                        }
                    };

                    var exportUrl = host + "/" + upgradeFromIndex;
                    exportUrl += "/_search?scroll=1m";
                    var postData = '{"fields":["_parent","_source"],"from":0,"size":10000,"query":{"bool":{"must":[],"must_not":[],' +
                        '"should":[{"match_all":{}}]}},"sort":[],"aggs":{},"version":true}';
                    var nr = "...";
                    var totalHits = NaN;
                    var totalFrom = NaN;
                    var totalSucc = NaN;
                    var errMsg = '';
                    var ajaxQuery = function (scrollId) {
                        if (!totalFrom) totalFrom = 0;
                        if (scrollId) {
                            exportUrl = host + '/_search/scroll?scroll=1m&scroll_id=' + scrollId;
                            postData = ''
                        }
                        $.ajax({
                            type: "POST",
                            url: exportUrl,
                            data: postData,
                            success: function (result) {
                                msgUpgradeResult(nr);
                                nr += '.';
                                if (!totalHits) {
                                    totalHits = result.hits.total;
                                    totalSucc = 0;
                                    msgUpgradeResult("需要升级总数：" + totalHits + "    已升级：" + 0);
                                }
                                if (typeof result.hits.hits === 'object' && result.hits.hits instanceof Array) {
                                    // console.log('ret5');
                                    // console.log(result.hits.hits.slice(0, 5));
                                    // exportResult.hits = exportResult.hits.concat(result.hits.hits);
                                    upgradeQuery(result);
                                }
                                if (totalFrom + 10000 < totalHits) {
                                    totalFrom += 10000;
                                    ajaxQuery(result._scroll_id);
                                }
                            },
                            error: function (xhr, ts, e) {
                                errMsg += 'ts    ';
                                msgUpgradeResult(errMsg);
                                console.error('error', ts, e);
                            }
                        });
                    }
                    ajaxQuery();
                    return false;
                });

                // flyway删除
                $("#deleteFlyBtn").on('click', function () {
                    var text = $("#deleteFlyVersion").val();
                    var searchUrl = host + '/flyway/flywayInfo/_search';
                    $.ajax({
                        type: "POST",
                        url: searchUrl,
                        data: '{"query": {"term": {"fVersion": "' + text + '"}}}',
                        success: function (result) {
                            if (!(result && result.hits.hits[0] && result.hits.hits[0]._id)) {
                                console.log('查询没有结果');
                                $("#flywayResult").text('查询没有结果');
                                return;
                            }
                            var id = result.hits.hits[0]._id;
                            var deleteUrl = host + '/flyway/flywayInfo/' + id;
                            $.ajax({
                                type: 'DELETE',
                                url: deleteUrl,
                                success: function (data) {

                                    if (data && data.found) {
                                        console.log('删除成功');
                                        $("#flywayResult").text('删除成功');
                                    }
                                },
                                error: function (data) {
                                    console.log(data);
                                }
                            });
                            return false;
                        },
                        error: function (result) {
                            msgBulkDeleteResult(JSON.stringify(result));
                            return false;
                        }
                    });
                });

                //    删除路由
                $("#deleteRoutingBtn").on('click', function () {
                    var routing = $("#routingDeleteValue").val();
                    var searchUrl = host + '/_search';
                    var bulkDelRoutingUrl = host + "/_bulk";

                    $.ajax({
                        url: searchUrl,
                        type: "POST",
                        data: '{"from":0,"size":10000,"query": {"term": {"_routing": "' + routing + '"}}}',
                        success: function (result) {
                            if (!(result && result.hits.hits[0] && result.hits.hits[0]._id)) {
                                console.log('查询没有结果');
                                $("#routingDelResult").text('查询没有结果');
                                return;
                            }
                            bulkDelete(bulkDelRoutingUrl, result, function (err) {
                                $("#routingDelResult").text('删除成功！共删除' + result.hits.hits.length + "条数据。");
                                return false;
                            }, routing);
                        },
                        error: function (err) {
                            $("#routingDelResult").text('获取路由下数据失败' + err);

                        }
                    });
                });

                // 批量导出
                $('#dataExportToggle').on('shown.bs.tab', function (e) {
                    console.log('here');
                    var sel = $('#exportSelectGroupN');
                    if (sel.html().trim() !== '') return;

                    var tpl1 = '<div class="checkbox"><label><input class="index-ck" data-index="{{index}}" type="checkbox" value="{{index}}"><b>{{index}}</b></label>{{indexHtml}}</div>';
                    var tpl2 = '<label class="checkbox-inline"><input class="type-ck" data-index="{{index}}" type="checkbox" value="{{type}}">{{type}}</label>';
                    var innerHtml = '<div class="checkbox"><label><input class="all-ck" type="checkbox" value=""><b>全选</b></label></div>';
                    var idx = Object.keys(indices);
                    idx.sort();
                    idx.forEach(function (index) {
                        var indexHtml = '';
                        var types = indices[index];
                        if (types.length > 0) indexHtml += '&nbsp;&nbsp;&nbsp;&nbsp;';
                        types.forEach(function (type) {
                            indexHtml += tpl2.replace(/{{index}}/g, index).replace(/{{type}}/g, type);
                        });

                        innerHtml += tpl1.replace(/{{index}}/g, index).replace(/{{indexHtml}}/g, indexHtml);
                    });
                    sel.html(innerHtml);

                    //events
                    sel.find('.all-ck').on('click', function () {
                        // console.log('click');
                        var isChecked = $(this).is(":checked");
                        var selIndex = sel.find('.index-ck');
                        var selType = sel.find('.type-ck');
                        if (isChecked) {
                            selIndex.prop("checked", "checked");
                            selType.prop("checked", "checked");
                        } else {
                            selIndex.removeAttr("checked");
                            selType.removeAttr("checked");
                        }
                    });

                    sel.find('.index-ck').on('change', function () {
                        // console.log('change');
                        var isChecked = $(this).is(":checked");
                        var selIndex = sel.find('.index-ck');
                        var selIndexChecked = sel.find('.index-ck:checked');
                        var index = $(this).attr('data-index');
                        var selType = sel.find('.type-ck[data-index=' + index + ']');
                        var selTypeChecked = sel.find('.type-ck[data-index=' + index + ']:checked');
                        if (isChecked) {
                            if (selIndexChecked.length === selIndex.length) sel.find('.all-ck').prop("checked", "checked");
                            if (selTypeChecked.length === 0) selType.prop("checked", "checked");
                        } else {
                            sel.find('.all-ck').removeAttr("checked");
                            selType.removeAttr("checked");
                        }
                    });

                    sel.find('.type-ck').on('click', function () {
                        // console.log('click');
                        var isChecked = $(this).is(":checked");
                        var index = $(this).attr('data-index');
                        var selIndex = sel.find('.index-ck[data-index=' + index + ']');
                        var selTypeChecked = sel.find('.type-ck[data-index=' + index + ']:checked');
                        if (isChecked) {
                            selIndex.prop("checked", "checked");
                            sel.find('.index-ck').trigger("change");
                        }
                        if (!isChecked && selTypeChecked.length === 0) {
                            selIndex.removeAttr("checked");
                            sel.find('.index-ck').trigger("change");
                        }
                    });
                });

                $("#exportFormN").on("submit", function (evt) {

                    var exportTotalResult = [];

                    evt.preventDefault();
                    msgExportNResult("...");

                    var routing = $("#exportRoutingN").val().trim();

                    var exportTypeQuery = function (index, type, routing) {
                        var exportUrl = host + "/" + index + "/" + type + "/_search?scroll=1m";
                        var exportResult = {};
                        var routingQurey = '';
                        if (routing) {
                            routingQurey = '{"term":{ "_routing":"' + routing + '"}}';
                        }
                        var postData = '{"size":10000,"query":{"bool":{"must":[' + routingQurey + '],"must_not":[],' +
                            '"should":[{"match_all":{}}]}},"sort":[],"aggs":{},"version":true}';
                        var nr = '...';
                        // console.log(routingQurey);
                        var ajaxQuery = function (from, scrollId) {
                            if (!from) from = 0;
                            if (scrollId) {
                                exportUrl = host + '/_search/scroll?scroll=1m&scroll_id=' + scrollId;
                                postData = ''
                            }
                            $.ajax({
                                type: "POST",
                                url: exportUrl,
                                data: postData,
                                success: function (result) {
                                    msgExportNResult(nr);
                                    nr += '.';
                                    if (typeof exportResult.total !== 'number') {
                                        exportResult.total = result.hits.total;
                                        exportResult.hits = [];
                                    }
                                    if (typeof result.hits.hits === 'object' && result.hits.hits instanceof Array) {
                                        // console.log('ret5');
                                        // console.log(result.hits.hits.slice(0, 5));
                                        exportResult.hits = exportResult.hits.concat(result.hits.hits);
                                    }
                                    if (from + 10000 < exportResult.total) ajaxQuery(from + 10000, result._scroll_id);
                                    else exportTotalResult.push({
                                        index: index,
                                        type: type,
                                        data: exportResult
                                    });
                                },
                                error: function (result) {
                                    msgExportNResult(JSON.stringify(result));
                                }
                            });
                        }
                        ajaxQuery();
                    }

                    var selTypeChecked = $('#exportSelectGroupN').find('.type-ck:checked');
                    selTypeChecked.each(function (ix, selType) {
                        selType = $(selType);
                        var index = selType.attr('data-index');
                        var type = selType.val();
                        exportTypeQuery(index, type, routing);
                    });

                    var timer = setInterval(function () {
                        if (exportTotalResult.length === selTypeChecked.length) {
                            // console.log(exportTotalResult);
                            clearInterval(timer);

                            // export file
                            var outContent = '// --------------------------------------------------------\n';
                            // author
                            outContent += '// ------------------ ElasticsearchTool -------------------\n';
                            // date
                            var cdate = new Date();
                            outContent += '// ------- ' + cdate.toString() + ' ---------\n';
                            outContent += '// --------------------------------------------------------\n';
                            outContent += '\n\n';
                            // data
                            exportTotalResult.forEach(function (typeData) {
                                outContent += '// --------------------------------------------------------\n';
                                outContent += '// ---------- index:' + typeData.index + '\n// ---------- type: ' + typeData.type + '\n';
                                outContent += 'global.' + typeData.type + ' = \'';
                                outContent += JSON.stringify(typeData.data);
                                outContent += '\'';
                                outContent += '\n';
                                outContent += '// --------------------------------------------------------\n\n';
                            });
                            // console.log(outContent);
                            msgExportNResult(outContent);
                            downloadFile('export' + cdate.getTime(), outContent, 'text/plain');
                        }
                    }, 200);

                    return false;
                });

            });

            function msgExportResult(msg) {
                $("#exportResult").html(msg);
            }

            // type import
            function msgImportResult(msg) {
                $("#importResult").text(msg);
            }

            // bulk delete
            function msgBulkDeleteResult(msg) {
                $("#bulkDeleteResult").html(msg);
            }

            function msgExportNResult(msg) {
                $("#exportNResult").html(msg);
            }

            function setHeight() {
                var th = $(window).height() - 69 - 41 - 5;
                $(".toolWrapper").height(Math.max(th, 755));
                $(".toolFrame").height($(".toolWrapper").height() - 12);


                // type export
                $("#exportResult").height($(".toolFrame").height() - 356 + 75);
                $("#importResult").height($(".toolFrame").height() - 356 + 75);

                $("#bulkDeleteResult").height($(".toolFrame").height() - 356 + 75 - 74 * 3);


            }

            function getState() {
                var url = host + "/_cluster/state";
                $.ajax({
                    type: "GET",
                    url: url,
                    success: function (data) {
                        if (typeof data.metadata !== 'object') {
                            if (--indices >= -3) setTimeout(getState, 250);
                            else console.error('getState: try 3 times without prefered result.');
                            return;
                        }
                        // console.log(data);
                        indices = {};
                        var data_indices = data.metadata.indices;
                        Object.keys(data_indices).forEach(function (index) {
                            var index_data = data_indices[index];
                            var index_mappings = index_data.mappings;

                            indices[index] = Object.keys(index_mappings);
                        });
                        console.log('indices', indices);
                        setAllIndex();
                    },
                    error: function (err) {
                        console.error('getState: error.');
                        console.error(err);
                    }
                });
            }

            /**
             * 获取所有索引
             */
            // function setAllIndex() {
            //     var url = host + "/_cat/indices";
            //     var indexOptions = [];
            //     var firstIndex = '';

            //     $.ajax({
            //         type: "GET",
            //         url: url,
            //         success: function(data) {
            //             // console.log(data);
            //             var indices_text = data.split("\n");
            //             indices_text.pop();

            //             indices_text.forEach(function(it) {
            //                 var arr = it.trim().split(/\s+/);
            //                 // indices.push(arr);
            //                 if (!firstIndex) {
            //                     firstIndex = arr[2];
            //                 }
            //                 indexOptions.push("<option value='" + arr[2] + "'>" + arr[2] + "</option>");
            //             });
            //             $("._index").append(indexOptions.toString());
            //             if (firstIndex) {
            //                 setTypes(firstIndex);
            //             }
            //         },
            //         error: function(result) {
            //             msgBulkDeleteResult(JSON.stringify(result));
            //             return false;
            //         }
            //     });


            // }
            function setAllIndex() {
                var indexOptions = [];
                var firstIndex = '';
                var t = Object.keys(indices)
                t.sort();
                t.forEach(function (index) {
                    if (!firstIndex) {
                        firstIndex = index;
                    }
                    indexOptions.push("<option value='" + index + "'>" + index + "</option>");
                });
                $("._index").append(indexOptions.toString());
                if (firstIndex) {
                    setTypes(firstIndex);
                }

            }

            /**
             * 根据索引设置类型
             */
            // function setTypes(index) {
            //     var url = host + "/" + index + "/_mapping";
            //     $.get(url, function(data) {
            //         var mapping = data[index].mappings;
            //         var types = Object.keys(mapping);
            //         $("._type").html(" ");
            //         types.forEach(function(type) {
            //             $("._type").append("<option value='" + type + "'>" + type + "</option>");
            //         });

            //     });
            // }
            function setTypes(index) {
                var types = indices[index];
                $("._type").html(" ");
                types.sort();
                types.forEach(function (type) {
                    $("._type").append("<option value='" + type + "'>" + type + "</option>");
                });
            }

            /**
             * 批量删除ES数据
             * @param deleteUrl  删除url
             * @param bulkDeleteObj  要删除的数据
             * @param routing  路由
             */
            function bulkDelete(deleteUrl, bulkDeleteObj, callback, routing) {

                var dataBody = '',
                    bulkBody = '';
                try {
                    if (typeof bulkDeleteObj.hits === "object" && !(bulkDeleteObj.hits instanceof Array) &&
                        typeof bulkDeleteObj.hits.hits === "object" && bulkDeleteObj.hits.hits instanceof Array) {
                        dataBody = bulkDeleteObj.hits.hits;
                    } else if (typeof bulkDeleteObj.hits === "object" && bulkDeleteObj.hits instanceof Array) {
                        dataBody = bulkDeleteObj.hits;
                    }
                } catch (err) {
                    console.error(err.message, err.stack);
                }
                for (var i = 0; i < dataBody.length; i++) {
                    var _index = dataBody[i]._index;
                    var _type = dataBody[i]._type;
                    routing = dataBody[i]._routing || routing
                    if (routing) {
                        bulkBody += '{"delete":{"_index":"' + _index + '","_type":"' + _type + '","_id":"' + dataBody[i]._id.trim() + '","_routing":"' + routing + '"}}\n';
                    } else {
                        bulkBody += '{"delete":{"_index":"' + _index + '","_type":"' + _type + '","_id":"' + dataBody[i]._id.trim() + '"}}\n';
                    }
                }
                if (!dataBody || (dataBody.length <= 0)) {
                    callback('该类型下没有数据', null);
                    // msgBulkDeleteResult('该类型下没有数据');
                    return false;
                }
                $.ajax({
                    type: "POST",
                    url: deleteUrl,
                    data: bulkBody,
                    success: function (result) {
                        callback(null);
                        // msgBulkDeleteResult(format(JSON.stringify(result), false));
                    },
                    error: function (err) {
                        callback(err, null);
                        // msgBulkDeleteResult(format(JSON.stringify(result), false));
                    }
                });
                return false;
            }

            /**
             * 根据id数组批量删除数据
             */
            function bulkDeleteByIds(deleteUrl, index, type, routing, idArr, callback) {
                if (!idArr || idArr.length <= 0) {
                    callback('没有可删除的数据', null);
                    return false;
                }
                var length = idArr.length;
                var bulkBody = '';
                for (var i = 0; i < length; i++) {
                    if (routing) {
                        bulkBody += '{"delete":{"_index":"' + index + '","_type":"' + type + '","_id":"' + idArr[i].trim() + '","_routing":"' + routing + '"}}\n';
                    } else {
                        bulkBody += '{"delete":{"_index":"' + index + '","_type":"' + type + '","_id":"' + idArr[i].trim() + '"}}\n';
                    }
                }
                $.ajax({
                    type: "POST",
                    url: deleteUrl,
                    data: bulkBody,
                    success: function (result) {
                        callback(null, result.items.length);
                    },
                    error: function (err) {
                        callback(err, null);
                    }
                });
            }

            /**
             * 获取请求地址
             * @returns {string}
             */
            function getHost() {

                var protocol = window.location.protocol;
                var hostname = window.location.hostname;
                return protocol + "//" + hostname + ":9200";

                // return 'http://192.168.30.60:9200';

            }

            /**
             * 文件下载
             * @param fileName
             * @param content
             */
            function downloadFile(fileName, content, ext) {
                var a = document.createElement('a');
                var defaultType = {
                    type: 'application/json'
                };
                if (ext) defaultType.type = ext;
                var blob = new Blob([content], {
                    type: defaultType
                });
                var url = window.URL.createObjectURL(blob);
                a.href = url;
                a.download = fileName;
                a.click();
                window.URL.revokeObjectURL(url);
            }


            // 格式化json
            function format(txt, compress /*是否为压缩模式*/) { /* 格式化JSON源码(对象转换为JSON文本) */
                var indentChar = '    ';
                if (/^\s*$/.test(txt)) {
                    alert('数据为空,无法格式化! ');
                    return;
                }
                try {
                    var data = eval('(' + txt + ')');
                } catch (e) {
                    alert('数据源语法错误,格式化失败! 错误信息: ' + e.description, 'err');
                    return;
                };
                var draw = [],
                    last = false,
                    This = this,
                    line = compress ? '' : '\n',
                    nodeCount = 0,
                    maxDepth = 0;

                var notify = function (name, value, isLast, indent /*缩进*/, formObj) {
                    nodeCount++; /*节点计数*/
                    for (var i = 0, tab = ''; i < indent; i++) tab += indentChar; /* 缩进HTML */
                    tab = compress ? '' : tab; /*压缩模式忽略缩进*/
                    maxDepth = ++indent; /*缩进递增并记录*/
                    if (value && value.constructor == Array) { /*处理数组*/
                        draw.push(tab + (formObj ? ('"' + name + '":') : '') + '[' + line); /*缩进'[' 然后换行*/
                        for (var i = 0; i < value.length; i++)
                            notify(i, value[i], i == value.length - 1, indent, false);
                        draw.push(tab + ']' + (isLast ? line : (',' + line))); /*缩进']'换行,若非尾元素则添加逗号*/
                    } else if (value && typeof value == 'object') { /*处理对象*/
                        draw.push(tab + (formObj ? ('"' + name + '":') : '') + '{' + line); /*缩进'{' 然后换行*/
                        var len = 0,
                            i = 0;
                        for (var key in value) len++;
                        for (var key in value) notify(key, value[key], ++i == len, indent, true);
                        draw.push(tab + '}' + (isLast ? line : (',' + line))); /*缩进'}'换行,若非尾元素则添加逗号*/
                    } else {
                        if (typeof value == 'string') value = '"' + value + '"';
                        draw.push(tab + (formObj ? ('"' + name + '":') : '') + value + (isLast ? '' : ',') + line);
                    };
                };
                var isLast = true,
                    indent = 0;
                notify('', data, isLast, indent, false);
                return draw.join('');
            }
        </script>
</body>

</html>
